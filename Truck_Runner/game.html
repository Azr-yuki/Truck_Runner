<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Truck Runner</title>
<style>
body {
  background: linear-gradient(to top, #87ceeb, #fff);
  overflow: hidden;
  font-family: 'Open Sans', sans-serif;
  transition: background 3s linear;
}
/* Loop-wrapper & background elements */
.loop-wrapper { margin: 0 auto; position: relative; width: 600px; height: 250px; overflow: hidden; border-bottom: 3px solid #fff; }
.loop-wrapper::after { content: ""; position: absolute; bottom: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.2); z-index: 3; }
.mountain { position: absolute; right: -900px; bottom: -20px; width: 2px; height: 2px; box-shadow:0 0 0 50px #4DB6AC,60px 50px 0 70px #4DB6AC,90px 90px 0 50px #4DB6AC,250px 250px 0 50px #4DB6AC,290px 320px 0 50px #4DB6AC,320px 400px 0 50px #4DB6AC; transform: rotate(130deg); animation: mtn 20s linear infinite; z-index:1; }
.hill { position: absolute; right: -900px; bottom: -50px; width: 400px; border-radius: 50%; height: 20px; box-shadow:0 0 0 50px #4DB6AC,-20px 0 0 20px #4DB6AC,-90px 0 0 50px,250px 0 0 50px,290px 0 0 50px,620px 0 0 50px; animation: hill 4s 2s linear infinite; z-index:2; }
.tree,.tree:nth-child(2),.tree:nth-child(3){height:100px;width:35px;bottom:0;background:url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/130015/tree.svg) no-repeat;z-index:3;}
.tree:nth-child(2){animation:tree2 2s linear infinite;}
.tree:nth-child(3){animation:tree3 8s linear infinite;}

/* Truck + wheels */
.truck-wrapper{position:absolute;bottom:0;left:100px;z-index:15;transition:bottom 0.3s ease;}
.truck{width:85px;height:60px;background:url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/130015/truck.svg) no-repeat;background-size:contain;}
.wheels{width:85px;height:15px;background:url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/130015/wheels.svg) no-repeat;background-size:contain;position:relative;bottom:5px;}
.jump{animation: jumpTruck 0.6s ease-out;}
@keyframes jumpTruck{0%{bottom:0;}50%{bottom:120px;}100%{bottom:0;}}

/* Obstacles */
.obstacle{position:absolute;bottom:0;z-index:10;transition:background 3s linear;}
.tire{width:30px;height:30px;background:black;border-radius:50%;}
.rock{width:25px;height:35px;background:#555;border-radius:5px;}
.debris{background:#8B4513;border-radius:3px;}

/* Overlay */
#overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:30;background:rgba(0,0,0,0.7);padding:20px;border-radius:10px;color:white;text-align:center;}

/* Score */
#score{position:absolute;top:10px;left:10px;z-index:50;font-size:20px;font-weight:bold;color:rgb(0,0,0);}

/* Auth/UI */
#auth-container{position:absolute;top:10px;right:10px;z-index:100;background:rgba(255,255,255,0.9);padding:8px;border-radius:6px;display:flex;gap:8px;align-items:center;}
#auth-container select,#auth-container input{padding:4px;border-radius:4px;border:1px solid #ddd;}
#auth-container button{padding:6px 8px;background:#4DB6AC;color:white;border:none;border-radius:4px;cursor:pointer;}
#user-profile{display:flex;gap:8px;align-items:center;}
#userPhoto{width:28px;height:28px;border-radius:50%;border:1px solid #4DB6AC;}

/* Leaderboard modal */
#leaderboardModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;align-items:center;justify-content:center;}
#leaderboardModal .modal-content{background:white;color:#222;padding:16px;border-radius:8px;min-width:260px;}

/* Background animations */
@keyframes tree{0%{transform:translate(1350px);}100%{transform:translate(-50px);}}
@keyframes tree2{0%{transform:translate(650px);}100%{transform:translate(-50px);}}
@keyframes tree3{0%{transform:translate(2750px);}100%{transform:translate(-50px);}}
@keyframes mtn{100%{transform:translateX(-2000px) rotate(130deg);}}
@keyframes hill{100%{transform:translateX(-2000px);}}
</style>
</head>
<body>
<div id="auth-container">
<div id="dbStatus" style="font-size:12px;color:#666;margin-right:8px">âšª Offline</div>
<div id="user-profile" style="display:none">
<img id="userPhoto" src="" alt="Profile">
<span id="userName"></span>
<button id="signOutBtn" style="margin-left:8px">Sign Out</button>
</div>
<div id="signin-container">
<button id="googleSignInBtn"><img src="https://www.google.com/favicon.ico" width="14" height="14" style="margin-right:8px">Sign in with Google</button>
</div>
<select id="userSelect" title="Switch user" style="min-width:140px"></select>
<input id="newUserName" placeholder="New user..." />
<button id="addUserBtn">Add</button>
<button id="removeUserBtn">Remove</button>
<button id="showLeaderboardBtn">Leaderboard</button>
</div>

<div class="loop-wrapper" id="loop-wrapper">
<div class="mountain"></div>
<div class="hill"></div>
<div class="tree"></div>
<div class="tree"></div>
<div class="tree"></div>
<div id="obstacles-container"></div>
<div class="truck-wrapper" id="truck-wrapper">
<div class="truck"></div>
<div class="wheels"></div>
</div>
<div id="score">Score: 0</div>
<div id="overlay">
<h1>Truck Runner</h1>
<p>Dodge debris on the road!</p>
<p style="font-size:12px;margin-top:-6px">Pick or create a user, each has separate saves.</p>
<button id="startBtn">Start Game</button>
</div>
</div>

<div id="leaderboardModal">
<div class="modal-content">
<h3>Leaderboard</h3>
<div id="leaderboardList" style="max-height:220px;overflow:auto"></div>
<div style="margin-top:8px;text-align:right">
<button id="closeLeaderboardBtn" style="background:#888">Close</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAjpAGju43D4gxe5rmWCU3ubS87_i6rnIc",
  authDomain: "truck-runner.firebaseapp.com",
  projectId: "truck-runner",
  storageBucket: "truck-runner.firebasestorage.app",
  messagingSenderId: "5012366741",
  appId: "1:5012366741:web:98be4db0150851023b029c",
  measurementId: "G-Y6701WR63E"
};

// DOM refs
const dbStatus = document.getElementById('dbStatus');
const userProfileEl = document.getElementById('user-profile');
const userPhoto = document.getElementById('userPhoto');
const userName = document.getElementById('userName');
const signinContainer = document.getElementById('signin-container');
const googleSignInBtn = document.getElementById('googleSignInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userSelect = document.getElementById('userSelect');
const newUserName = document.getElementById('newUserName');
const addUserBtn = document.getElementById('addUserBtn');
const removeUserBtn = document.getElementById('removeUserBtn');
const showLeaderboardBtn = document.getElementById('showLeaderboardBtn');
const leaderboardModal = document.getElementById('leaderboardModal');
const leaderboardList = document.getElementById('leaderboardList');
const closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
const startBtn = document.getElementById('startBtn');
const overlay = document.getElementById('overlay');
const truckWrapper = document.getElementById('truck-wrapper');
const obstaclesContainer = document.getElementById('obstacles-container');
const scoreDisplay = document.getElementById('score');

const USERS_KEY = 'truckRunnerUsers';
const CURRENT_USER_KEY = 'truckRunnerCurrentUserId';

let app = null;
let auth = null;
let db = null;
let firebaseAvailable = false;
let authUser = null;
let localUsers = [];
let localCurrentUser = null;

let score = 0;
let isJumping = false;
let isGameOver = false;
let gameStarted = false;
const obstacles = [];
let obstacleSpeed = 8;
let scoreIntervalId = null;

// helpers
function showStatus(text,color='#666'){if(dbStatus){dbStatus.textContent=text;dbStatus.style.color=color;}}

function loadLocalUsers(){
  try{localUsers=JSON.parse(localStorage.getItem(USERS_KEY)||'[]');}catch(e){localUsers=[];}
  const id=localStorage.getItem(CURRENT_USER_KEY);
  localCurrentUser=localUsers.find(u=>u.id===id)||(localUsers[0]||null);
}

function saveLocalUsers(){
  localStorage.setItem(USERS_KEY,JSON.stringify(localUsers));
  localStorage.setItem(CURRENT_USER_KEY,localCurrentUser?localCurrentUser.id:'');
}

function addLocalUser(name){
  if(!name||!name.trim())return null;
  const id='local-'+Date.now();
  const u={id,name:name.trim(),highScore:0,scores:[]};
  localUsers.push(u);
  saveLocalUsers();
  populateLocalUserSelect();
  switchLocalUser(id);
  return u;
}

function removeLocalUser(id){
  if(!id)return;
  localUsers=localUsers.filter(x=>x.id!==id);
  if(localCurrentUser&&localCurrentUser.id===id)localCurrentUser=localUsers[0]||null;
  saveLocalUsers();
  populateLocalUserSelect();
  updateUI();
}

function switchLocalUser(id){
  localCurrentUser=localUsers.find(u=>u.id===id)||null;
  saveLocalUsers();
  updateUI();
}

function populateLocalUserSelect(){
  if(!userSelect)return;
  userSelect.innerHTML='';
  localUsers.forEach(u=>{
    const opt=document.createElement('option');
    opt.value=u.id;
    opt.textContent=`${u.name} (High: ${u.highScore||0})`;
    if(localCurrentUser&&u.id===localCurrentUser.id)opt.selected=true;
    userSelect.appendChild(opt);
  });
  if(localUsers.length===0){
    const opt=document.createElement('option');
    opt.value='';
    opt.textContent='-- no users --';
    userSelect.appendChild(opt);
  }
}

function updateUI(){
  if(authUser){
    userProfileEl.style.display='flex';
    signinContainer.style.display='none';
    userPhoto.src=authUser.photoURL||`https://via.placeholder.com/28?text=${(authUser.displayName||'U')[0]}`;
    userName.textContent=authUser.displayName||authUser.email||'User';
    userSelect.style.display='none';
    newUserName.style.display='none';
    addUserBtn.style.display='none';
    removeUserBtn.style.display='none';
  }else{
    userProfileEl.style.display='flex';
    signinContainer.style.display='block';
    userSelect.style.display='inline-block';
    newUserName.style.display='inline-block';
    addUserBtn.style.display='inline-block';
    removeUserBtn.style.display='inline-block';
    loadLocalUsers();
    populateLocalUserSelect();
    if(localCurrentUser){
      userPhoto.src='https://via.placeholder.com/28?text='+encodeURIComponent(localCurrentUser.name.charAt(0).toUpperCase());
      userName.textContent=`${localCurrentUser.name} (High: ${localCurrentUser.highScore||0})`;
    }else{userProfileEl.style.display='none';}
  }
}

// Firebase init
try{
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  firebaseAvailable = true;
  showStatus('ðŸŸ¢ Online','#4caf50');
}catch(e){
  console.warn('Firebase init failed',e);
  firebaseAvailable=false;
  showStatus('âšª Offline','#666');
}

// reliable Firebase status check
async function checkFirebaseStatus(){
  if(!firebaseAvailable||!db){showStatus('âšª Offline','#666');return;}
  try{
    await getDocs(query(collection(db,'users'),limit(1)));
    showStatus('ðŸŸ¢ Online','#4caf50');
  }catch(e){
    console.warn('Firebase DB unreachable',e);
    showStatus('âš  Offline / DB unreachable','#b35000');
  }
}
if(firebaseAvailable && db){
  checkFirebaseStatus();
  setInterval(checkFirebaseStatus,15000);
}

// Google Auth
if(googleSignInBtn)googleSignInBtn.addEventListener('click',async()=>{
  const provider=new GoogleAuthProvider();
  try{
    const result=await signInWithPopup(auth,provider);
    authUser=result.user;
    updateUI();
  }catch(e){console.error('Sign-in failed',e);}
});

if(signOutBtn)signOutBtn.addEventListener('click',async()=>{
  if(authUser){await signOut(auth);authUser=null;}
  updateUI();
});

onAuthStateChanged(auth,user=>{
  authUser=user;
  updateUI();
});

// Local user buttons
if(addUserBtn)addUserBtn.addEventListener('click',()=>{const u=addLocalUser(newUserName.value);if(u)newUserName.value='';});
if(removeUserBtn)removeUserBtn.addEventListener('click',()=>{if(localCurrentUser)removeLocalUser(localCurrentUser.id);});
if(userSelect)userSelect.addEventListener('change',()=>{switchLocalUser(userSelect.value);});

// Score handling
function saveScoreLocalFallback(finalScore){
  if(!localCurrentUser)return;
  localCurrentUser.scores=localCurrentUser.scores||[];
  localCurrentUser.scores.push({score:finalScore,timestamp:new Date().toISOString()});
  if(!localCurrentUser.highScore||finalScore>localCurrentUser.highScore)localCurrentUser.highScore=finalScore;
  saveLocalUsers();
}

async function saveScore(finalScore){
  if(authUser&&firebaseAvailable&&db){
    try{
      await addDoc(collection(db,'scores'),{
        userId:authUser.uid,
        userName:authUser.displayName||authUser.email||'Unknown',
        score:finalScore,
        timestamp:new Date().toISOString()
      });
      const userRef=doc(db,'users',authUser.uid);
      const userDoc=await getDoc(userRef);
      const currentHigh=userDoc.exists()?userDoc.data().highScore||0:0;
      if(finalScore>currentHigh)await setDoc(userRef,{highScore:finalScore},{merge:true});
      return;
    }catch(e){
      console.error('Failed to save score to Firestore, saving locally:',e);
      saveScoreLocalFallback(finalScore);
    }
    return;
  }
  saveScoreLocalFallback(finalScore);
}

// Leaderboard
async function openLeaderboard(){
  leaderboardList.innerHTML='';
  if(firebaseAvailable&&db){
    try{
      const scoresSnap=await getDocs(query(collection(db,'scores'),orderBy('score','desc'),limit(10)));
      if(scoresSnap.empty){leaderboardList.innerHTML='<div style="padding:8px">No scores yet.</div>';}
      else{
        let i=1;
        scoresSnap.forEach(docSnap=>{
          const data=docSnap.data();
          const time=data.timestamp?new Date(data.timestamp).toLocaleString():'â€”';
          const div=document.createElement('div');
          div.style.padding='6px 0';
          div.textContent=`${i++}. ${data.userName||'Unknown'} â€” Score: ${data.score} â€” ${time}`;
          leaderboardList.appendChild(div);
        });
      }
      leaderboardModal.style.display='flex';
    }catch(e){
      console.error('Error loading leaderboard',e);
      leaderboardList.innerHTML='<div style="padding:8px">Error loading leaderboard.</div>';
      leaderboardModal.style.display='flex';
    }
    return;
  }
  // Local fallback
  if(!localUsers||localUsers.length===0){leaderboardList.innerHTML='<div style="padding:8px">No users yet.</div>';}
  else{
    const allScores=[];
    localUsers.forEach(u=>{if(u.scores)u.scores.forEach(s=>allScores.push({name:u.name,score:s.score,timestamp:s.timestamp}));});
    if(allScores.length===0){leaderboardList.innerHTML='<div style="padding:8px">No scores yet.</div>';}
    else{
      allScores.sort((a,b)=>b.score-a.score);
      allScores.slice(0,10).forEach((s,i)=>{
        const div=document.createElement('div');
        div.style.padding='6px 0';
        div.textContent=`${i+1}. ${s.name} â€” Score: ${s.score} â€” ${s.timestamp?new Date(s.timestamp).toLocaleString():'â€”'}`;
        leaderboardList.appendChild(div);
      });
    }
    leaderboardModal.style.display='flex';
  }
}

if(showLeaderboardBtn)showLeaderboardBtn.addEventListener('click',openLeaderboard);
if(closeLeaderboardBtn)closeLeaderboardBtn.addEventListener('click',()=>{leaderboardModal.style.display='none';});

// Game start / loop
startBtn.addEventListener('click',()=>{overlay.style.display='none';startGame();});

function startGame(){
  if(gameStarted)return;
  gameStarted=true;
  score=0;
  obstaclesContainer.innerHTML='';
  obstacles.length=0;
  scoreDisplay.textContent='Score: 0';
  isGameOver=false;
  obstacleSpeed=8;

  scoreIntervalId=setInterval(()=>{if(!isGameOver){score+=1;scoreDisplay.textContent='Score: '+score;}},200);

  requestAnimationFrame(gameLoop);
  spawnObstacleLoop();
}

function gameOver(){
  isGameOver=true;
  gameStarted=false;
  clearInterval(scoreIntervalId);
  saveScore(score);
  overlay.style.display='block';
  overlay.innerHTML=`<h1>Game Over</h1><p>Score: ${score}</p><button id="startBtn">Restart</button>`;
  document.getElementById('startBtn').addEventListener('click',()=>{overlay.style.display='none';startGame();});
}

// Player jump
document.addEventListener('keydown',e=>{if(e.code==='Space'&&!isJumping&&!isGameOver){jump();}});

function jump(){isJumping=true;truckWrapper.classList.add('jump');setTimeout(()=>{truckWrapper.classList.remove('jump');isJumping=false;},600);}

// Obstacles
function spawnObstacleLoop(){
  if(isGameOver)return;
  spawnObstacle();
  setTimeout(spawnObstacleLoop,2000+Math.random()*1500);
}

function spawnObstacle(){
  const types=['tire','rock','debris'];
  const type=types[Math.floor(Math.random()*types.length)];
  const el=document.createElement('div');
  el.classList.add('obstacle',type);
  el.style.right='-60px';
  obstaclesContainer.appendChild(el);
  obstacles.push({el,type});
}

function gameLoop(){
  if(isGameOver)return;
  obstacles.forEach((o,i)=>{
    let currentRight=parseInt(o.el.style.right.replace('px',''));
    currentRight+=obstacleSpeed;
    o.el.style.right=currentRight+'px';
    // collision
    const truckRect=truckWrapper.getBoundingClientRect();
    const obsRect=o.el.getBoundingClientRect();
    if(!(truckRect.right<obsRect.left||truckRect.left>obsRect.right||truckRect.bottom<obsRect.top||truckRect.top>obsRect.bottom)){
      gameOver();
    }
    if(currentRight>700){o.el.remove();obstacles.splice(i,1);}
  });
  requestAnimationFrame(gameLoop);
}

// Initialize
loadLocalUsers();
updateUI();
</script>
</body>
</html>
